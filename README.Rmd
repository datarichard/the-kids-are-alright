---
title: "Differential trends in mental health in Australia"
author: "F Botha^1,4^, RW Morris^1-3^, P Butterworth^4,5^, N Glozier^1,2^"
output:
   github_document:
     df_print: kable
bibliography: src/references.bib
csl: src/pnas.csl
editor_options:
  chunk_output_type: console
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  #eval = T,
  fig.path = "figures/",
  dpi=300
  )

`%notin%` <- Negate(`%in%`)
```

\ 

1.  ARC Centre of Excellence for Children and Families over the Life Course
2.  Central Clinical School, Faculty of Medicine and Health, University of Sydney, NSW, Australia
3.  School of Psychology, Faculty of Science, University of Sydney, NSW, Australia
4.  Melbourne Institute: Applied Economic & Social Research, The University of Melbourne, VIC, Australia
5.  National Centre for Epidemiology and Population Health, The Australian National University, ACT, Australia

<br><br>

\ 

\ 

\ 

Acknowledgement: This research was supported by the Australian Government through the Australian Research Council's Centre of Excellence for Children and Families over the Life Course (Project ID CE200100025)

<br><br>

## README  

This README describes the data preprocessing, main analysis and figure construction used in the paper titled "The kids are not ok: Differential trends in mental health in Australia".    

The following R libraries are required to perform the main analysis and create figures 1 & 2.  

```{r libraries, message=F, warning=F, echo=T}
library(tidyverse)
library(mgcv)
library(patchwork)
```

<br><br>


## Project layout  

The folder structure and file location of the code used in the project is described below.  

|– README.md *(this file)*  
|- LICENSE *(CC-BY-3.0)*  
|- README.Rmd *(makefile for README)*  
|- PNAS.Rmd *(makefile for PNAS resubmission)*  
|- PNAS_SI.Rmd *(makefile for PNAS SI)*  
|  
|  
|– data/ *(data required for project, i.e., inputs))*  
|–– preprocessed.RDS *(preprocessed data after import-and-preprocessing)*
|   
|  
|– figures/ *(plots and figures generated by project, i.e., outputs)*  
|–– figure_1-1.png  
|–– figure_2-1.png  
|–– figure_A1-1.png  
|  
|  
|– results/ *(data generated by project, i.e., outputs)*  
|–– gam_50v40.rds *(model fit object)*  
|–– gam_60v50.rds *(model fit object)*  
|–– gam_70v60.rds *(model fit object)*  
|–– gam_80v70.rds *(model fit object)*  
|–– gam_90v80.rds *(model fit object)*  
|  
|  
|– src/ *(scripts to generate outputs)*  
|–– import-and-preprocessing.R *(script for importing HILDA data)*  
|–– references.bib *(bibtex file)*  
|–– pnas.csl *(PNAS reference style)*  
|–– Rmarkdown-for-PNAS.docx *(MS Word template for PNAS style)*  

<br><br>


## Import data  

Data were obtained by application from the Australian Government Department of Social Services Dataverse website: https://www.dss.gov.au/about-the-department/longitudinal-studies/living-in-australia-hilda-household-income-and-labour-dynamics-in-australia-overview

After application was approved, we downloaded the combined dataset comprising the following 20 files:  

```{r, echo=F}
path_to_hilda <- list.files(
  path = '~/Dropbox (Sydney Uni)/HILDA/data',
  pattern = '^Combined.*.dta$',
  full.names = FALSE
) 

path_to_hilda
```

Data preprocessing was performed as described in `import-and-preprocessing.R`  


The MHI-5 data along with age and unique (crosswave) person IDs were imported for the main analysis and transformed to create age-group and cohort variables.  

```{r import_preprocessed_data}
hilda.data <- read_rds("data/preprocessed.RDS") %>% 
  select(xwaveid, year, age, ghmh) %>%
  filter(ghmh > 0) %>% # select valid MHI-5 values
  mutate(
    age_group = case_when(
      age <= 14 ~ "0-14",  # there is n = 1 fourteen year old
      age <= 24 ~ "15-24", 
      age <= 34 ~ "25-34",
      age <= 44 ~ "35-44",
      age <= 54 ~ "45-54",
      age <= 65 ~ "55-64",
      age <= 75 ~ "65-74",
      age <= 85 ~ "75-84",
      TRUE      ~ "85+"),
    birthyear = year - age,
    cohort = case_when(
      birthyear %in% 1900:1929 ~ "1920s",
      birthyear %in% 1930:1939 ~ "1930s", 
      birthyear %in% 1940:1949 ~ "1940s",
      birthyear %in% 1950:1959 ~ "1950s",
      birthyear %in% 1960:1969 ~ "1960s",
      birthyear %in% 1970:1979 ~ "1970s",
      birthyear %in% 1980:1989 ~ "1980s",
      birthyear %in% 1990:1999 ~ "1990s",
      birthyear %in% 2000:2009 ~ "2000s", 
      birthyear %in% 2010:2020 ~ "2010s", 
      TRUE ~ "problem"
    )) %>%
  mutate(xwaveid = factor(xwaveid),
         ocohort = ordered(cohort))
```

```{r peek, echo=F}
as_tibble(hilda.data) %>%
  head(10)
```

- `ghmh` is the MHI-5 score for each person in each year (0-100)
- `xwaveid` is the unique crosswave ID for each person to link records across years/waves
- `ocohort` is an ordered factor variable, which is a prerequisite to estimate difference smooths in **mgcv**  

<br><br>

## Analysis  

We estimate penalized smooth trends for each cohort using restricted maximum likelihood (REML) in a generalized additive mixed modelling (GAMM) setting, described by Wood et al [@wood2004stable; @wood2006low; @wood2011fast; @wood2016smoothing]. This is an analogue to a linear multilevel model with varying intercepts and slopes among the cohorts, but here the slopes are allowed to "wiggle". The model includes a global smoothing term for the effect of age as well as cohort-specific terms, so each cohort is allowed to have it's own functional response but the penalty ensures that functions too far from average are penalized.  

Each smoother $f_k$ is represented by a sum of $K$ simpler, fixed basis functions. The basis functions (splines) were estimated by quadratically penalized likelihood maximization for automatic smoothness selection, with a starting value of $K=9$.

$\ \ \ \ y_{it} = \beta_{k}(cohort_i) + f(age_{it}) + f_{[k]} (age_{it}) + \zeta_{i} + \epsilon_{it}$

$\ \ \ \ \epsilon_{it} \sim N(0, \phi \sigma^2)$

Where $y_{it}$ is the MHI-5 score for each person $i$ over age $t$; $\beta_{[k]}$ is the mean MHI-5 estimate for each $k = 1...6$ birth cohort, after accounting for variations in trend over age; and $f_{[k]}$ are smooth functions for the trend in MHI-5 scores over age for each cohort.  

The smooth trends were centered for identifiability reasons [@marra2012coverage; @wood2013p], however the resulting model estimation allowed two important comparisons: Firstly the mean MHI-5 estimates ($\beta_{[k]}$) provided comparisons for the average difference in mental health between cohorts. However interpreting these differences is difficult in the presence of trends over age in each cohort. For example, a mean difference could be due to a decreasing trend with age in one cohort or an increasing trend in the other cohort, rather than consistent differences in mental health over the age range. Thus an important advantage provided by the current model are the centered $f_{[k]}$ smooth functions from which differences in trends between cohorts are directly estimated. The resulting difference smooths are also centered around zero and so mean differences in mental health are not accounted for by these smooths, but they will reveal whether mental health is changing with age in one cohort relative to the other cohort (aka _reference_ cohort). The difference smooths also directly estimate the uncertainty around the difference, with confidence intervals that include the uncertainty about the mean difference as well as the centered smooth itself. This results in intervals with close to nominal (frequentist) coverage probabilities [@marra2012coverage].   

We did not compare cohorts more than a decade apart since there are few or no overlapping age groups observed, so we restricted ourselves to the five ($K-1$) pairwise comparisons between each cohort and the next oldest cohort (i.e., the *reference* cohort).  

To account for the person-level dependency when survey participants are measured more than once, we included a first-order autoregressive AR(1) term $\phi$ for the residuals based on the unique crosswave ID for each person $i = 1...I$, which is equivalent to including the person-level random intercept $\zeta_i$ nested within cohort.    

The model call in `mgcv` using the imported hilda.data (above) was:  

```
gamm(
      formula = ghmh ~ cohort + s(age) + s(age, by = ocohort),
      method = "REML",
      correlation = corAR1(form=~1|xwaveid),
      data = hilda.data
    ) 
```

Where `ghmh` is the MHI-5 score for each person in each year, `cohort` is the parametric term for the ordered factor (`ocohort`), which allows us to account for differences in the mean effect of cohort after the individual smooths are centered for identifiability reasons. The first `s(age)` is the smooth effect of age on the _reference_ level of the ordered factor. The second `s(age, by = ocohort)`is the _difference_ smooth, which models the smooth difference between the reference cohort and the target cohort   

<br>


Model fitting was performed on each consecutive pair of cohorts, and the complete model fitting code is shown below with options for Restricted Maximum Likelihood estimation (REML), as well as the correlation structure to account for the person-level dependency.  

```{r model_fitting, eval=F}
difference_gam <- function(.dat, cohorts) {
  
  cohorts <- sort(cohorts)
  
  .dat %>%
    filter(cohort %in% cohorts) %>%
    droplevels() %>%
    gamm(
      formula = ghmh ~ cohort + s(age) + s(age, by = ocohort),
      method = "REML",
      correlation = corAR1(form=~1|xwaveid),
      data = .
    ) 
}

difference_gam(hilda.data, c("1990s", "1980s")) %>%
  write_rds("results/gam_90v80.rds")

difference_gam(hilda.data, c("1980s", "1970s")) %>%
  write_rds("results/gam_80v70.rds")

difference_gam(hilda.data, c("1970s", "1960s")) %>%
  write_rds("results/gam_70v60.rds")

difference_gam(hilda.data, c("1960s", "1950s")) %>%
  write_rds("results/gam_60v50.rds")

difference_gam(hilda.data, c("1950s", "1940s")) %>%
  write_rds("results/gam_50v40.rds")
```

<br>

After accounting for the person-level dependency between years, a plot of the autocorrelation function (ACF) estimation of the residuals of each model indicates there is not a great deal of correlation between adjacent observations.  


```{r figure_A1, fig.dim = c(6, 15), out.width="50%", echo=F}
# layout(matrix(5:1, ncol = 1))
par(mfcol = c(5,1),
    # mar = c(1, 1, 4, 5), # default = c(5, 4, 4, 2)
    ask=F)

read_rds("results/gam_90v80.rds") %>% 
  .$lme %>%
  resid(type = "normalized") %>%
  acf(lag.max = 12, main = "90sv80s", ci=0)

read_rds("results/gam_80v70.rds") %>% 
  .$lme %>%
  resid(type = "normalized") %>%
  acf(lag.max = 12, main = "80sv70s", ci=0)

read_rds("results/gam_70v60.rds") %>% 
  .$lme %>%
  resid(type = "normalized") %>%
  acf(lag.max = 12, main = "70sv60s", ci=0)

read_rds("results/gam_60v50.rds") %>% 
  .$lme %>%
  resid(type = "normalized") %>%
  acf(lag.max = 12, main = "60sv50s", ci=0)

read_rds("results/gam_50v40.rds") %>% 
  .$lme %>%
  resid(type = "normalized") %>%
  acf(lag.max = 12, main = "50sv40s", ci=0)
```

<br><br>

## Results  


##### Figure 1. Age and cohort effects on mental health over the past two decades

```{r prepare_figure_1}
plot.data <- hilda.data %>%
  filter(cohort %in% c("1940s", "1950s", "1960s", "1970s", "1980s", "1990s")) %>%
  filter(age_group %notin% c("0-14", "75-84", "85+"))

ylims = c(65, 80)

left_panel <- ggplot(plot.data, aes(x = year, y = ghmh)) +
  geom_smooth(aes(group = 1), 
              method = "gam", formula = y ~ s(x, bs = "cs"), 
              se=F, color = "black", size = .5, linetype = "dashed") +
  geom_smooth(aes(group = age_group, color = age_group), 
              method = "gam", formula = y ~ s(x, bs = "cs"), se=F) +
  labs(
    subtitle = paste("Smoothed MHI-5 scores 0-100 (by age group)"), 
    y = "", x = "\n Survey year") +
  coord_cartesian(ylim = ylims) +
  scale_color_manual(values = rev(blues9)) +
  guides(color = guide_legend(title = "Age group")) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"),
        legend.title = element_text(size = 10),
        legend.position = c(0.2, 0.25),
        axis.title.x = element_text(size = 10))


right_panel <- ggplot(plot.data, aes(x = age, y = ghmh)) +
  geom_smooth(aes(group = 1), 
              method = "gam", formula = y ~ s(x, bs = "cs"), 
              se=F, color = "black", size = .5, linetype = "dashed") +
  geom_smooth(aes(group = cohort, color = cohort), 
              method = "gam", formula = y ~ s(x, bs = "cs"), 
              se=F, alpha = 0.2) +
  labs(
    subtitle = "Smoothed MHI-5 scores 0-100 (by cohort)", 
    y = "", x = "\n Age (years)") +
  coord_cartesian(ylim = ylims) +
  scale_color_manual(values = blues9[3:9]) +
  guides(color = guide_legend(title = "Birth cohort")) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"),
        legend.title = element_text(size = 10),
        legend.position = c(0.85, 0.25),
        axis.title.x = element_text(size = 10))
```

```{r figure_1, fig.dim=c(7,5), echo=F}
left_panel + right_panel
```

<br>

<br><br>

##### Table 3. Pairwise differences in average mental health between cohorts  

```{r mean_difference_table}
gam.list <- list(
  `90v80s` = read_rds("results/gam_90v80.rds") %>% .$gam,
  `80v70s` = read_rds("results/gam_80v70.rds") %>% .$gam,
  `70v60s` = read_rds("results/gam_70v60.rds") %>% .$gam,
  `60v50s` = read_rds("results/gam_60v50.rds") %>% .$gam,
  `50v40s` = read_rds("results/gam_50v40.rds") %>% .$gam
)


map_dfr(gam.list, .f = ~broom::tidy(., parametric=T, conf.int=T), 
        .id = "model") %>%
  mutate(across(where(is.double), ~round(., 3))) %>%
  filter(str_detect(term, "cohort")) %>%
  select(contrast = model, conf.low, estimate, conf.high, p.value) %>%
  mutate(contrast = str_replace(contrast, "v", "s - "))
```

<br>

Significant pairwise differences between each cohort and the reference cohort occurred (*ps* < .05), indicating lower mental health scores in the younger cohort of each comparison. These results represent the mean differences in MHI-5 scores of each cohort, and as such interpreting these differences is difficult in the presence of trends over age in each cohort. For example, the mean difference could be due to a decreasing trend with age in the younger cohort, or an increasing trend in the older cohort, rather than differences in mental health over all ages. Paiwise comparisons of the smooth trends over age for each cohort are presented below.    



Figure 2 shows the smooth trend estimates, along with 95% credible/confidence intervals (which include the uncertainty about the overall mean as well as the centred smooth itself). In each row the older cohort is shown in the left column as the 'reference smooth', and the estimated difference between the reference cohort and the cohort born in the subsequent decade is shown in the right column as the 'difference smooth'. A significant difference in trend or slope is indicated by 95% confidence/credible intervals which exclude zero (horizonal line) in opposite directions at each endpoint.   

##### Figure 2. Centered estimates of cohort trajectories (left) and their differences to the subsequent cohort (right)

```{r figure_2_prep, include=F}
plot.data <- gam.list %>% 
  map2(.x = ., .y = names(gam.list), .f = ~{
    
    par(mfrow = c(2, 1), ask=F)
    plot_obj <- plot(.x, seWithMean = T)
    
    bind_rows(
      
      as.data.frame(plot_obj[[1]][c("x", "se", "fit")]) %>%
        mutate(cohort = paste0("19", substring(.y, 4, 6), " smooth")),
      
      as.data.frame(plot_obj[[2]][c("x", "se", "fit")]) %>%
        mutate(cohort = paste0("19", substring(.y, 1, 2), " difference"))
    )
    
  }) 

difference_plot <- function(.df) {
  ggplot(.df, aes(x = x, y = fit)) +
    geom_hline(aes(yintercept=0), size = 0.1) + 
    geom_ribbon(aes(ymin = fit - se, ymax = fit + se, y = NULL),
                fill = "grey80") +
    geom_line() +
    facet_wrap(~cohort) +
    labs(x = "Age (years)", y = "MHI-5 units") +
    theme_minimal(base_size = 9) +
    theme(panel.grid = element_blank(),
          axis.title = element_text(size = 7))
}

first_panel_row  <- difference_plot(plot.data[[1]])
second_panel_row <- difference_plot(plot.data[[2]])
third_panel_row  <- difference_plot(plot.data[[3]])
fourth_panel_row <- difference_plot(plot.data[[4]])
bottom_panel_row <- difference_plot(plot.data[[5]])
```

```{r figure_2_print_only, eval=F}
plot.data <- gam.list %>% 
  map2(.x = ., .y = names(gam.list), .f = ~{
    
    plot_obj <- plot(.x, seWithMean = T)
    # seWithMean = T for confidence intervals that include the uncertainty about
    # the overall mean as well as the centred smooth itself. This results in 
    # intervals with close to nominal (frequentist) coverage probabilities 
    # (Marra & Woods, 2012).
    
    bind_rows(
      
      as.data.frame(plot_obj[[1]][c("x", "se", "fit")]) %>%
        mutate(cohort = paste0("19", substring(.y, 4, 6), " smooth")),
      
      as.data.frame(plot_obj[[2]][c("x", "se", "fit")]) %>%
        mutate(cohort = paste0("19", substring(.y, 1, 2), " difference"))
    )
    
  }) 

difference_plot <- function(.df) {
  ggplot(.df, aes(x = x, y = fit)) +
    geom_hline(aes(yintercept=0), size = 0.1) + 
    geom_ribbon(aes(ymin = fit - se, ymax = fit + se, y = NULL),
                fill = "grey80") +
    geom_line() +
    facet_wrap(~cohort) +
    labs(x = "Age (years)", y = "MHI-5 units") +
    theme_minimal(base_size = 9) +
    theme(panel.grid = element_blank(),
          axis.title = element_text(size = 7))
}

first_panel_row  <- difference_plot(plot.data[[1]])
second_panel_row <- difference_plot(plot.data[[2]])
third_panel_row  <- difference_plot(plot.data[[3]])
fourth_panel_row <- difference_plot(plot.data[[4]])
bottom_panel_row <- difference_plot(plot.data[[5]])
```

```{r figure_2, fig.dim=c(4, 8), out.width="80%", echo=F}
first_panel_row / second_panel_row / third_panel_row / fourth_panel_row / bottom_panel_row
```

<br>

<br>

##### Table 4. Approximate significance of smooth differences  

```{r difference_table}
map_dfr(gam.list, .f = broom::tidy, .id = "model") %>%
  left_join(
    map_dfr(gam.list, .f = ~mgcv:::k.check(.) %>% 
              as_tibble(rownames = "term"), 
            .id = "model"),
    by = c("model", "term", "edf")
  ) %>%
  select(term, `k-index`, edf, F.value = statistic, p.value) %>%
  filter(str_detect(term, "ocohort")) %>%
  mutate(term = str_remove(term, "s\\(age\\):ocohort"),
         term = paste(term, "difference")) %>%
  mutate(across(`k-index`:F.value, ~round(., 2))) %>%
  mutate(p.value = round(p.value, 3))
```

<br>

The p-values indicate that cohort effects exist between each of the younger cohorts and the next oldest cohort, with the exception of the 1960s cohort difference from the 1950s, and the 1950s difference from 1940s.    

<br><br>


## References
